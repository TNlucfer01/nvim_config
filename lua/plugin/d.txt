return {
	-- Core DAP
	{
		"mfussenegger/nvim-dap",
		config = function()
			-- You can add custom dap.adapter setup here later if needed
		end,
	},

	-- DAP UI
	{
		"rcarriga/nvim-dap-ui",
		dependencies = {
			"mfussenegger/nvim-dap",
			"nvim-neotest/nvim-nio", -- Required
		},
		config = function()
			local dap = require("dap")
			local dapui = require("dapui")

			dapui.setup()

			-- Auto open/close dap-ui
			dap.listeners.after.event_initialized["dapui_config"] = function()
				dapui.open()
			end
			dap.listeners.before.event_terminated["dapui_config"] = function()
				dapui.close()
			end
			dap.listeners.before.event_exited["dapui_config"] = function()
				dapui.close()
			end
		end,
	},

	-- Mason DAP
	{
		"jay-babu/mason-nvim-dap.nvim",
		dependencies = {
			"williamboman/mason.nvim",
			"mfussenegger/nvim-dap",
		},
		config = function()
			require("mason-nvim-dap").setup({
				ensure_installed = { "java-debug-adapter", "java-test" },
				handlers = {
					function(config)
						-- all sources with no handler get passed here
						-- Keep original functionality
						require("mason-nvim-dap").default_setup(config)
					end,
					python = function(config)
						config.adapters = {
							type = "executable",
							command = "/usr/bin/python3",
							args = {
								"-m",
								"debugpy.adapter",
							},
						}
						require("mason-nvim-dap").default_setup(config) -- don't forget this!
					end,
				},
			})

			-- Java DAP Configuration
			local dap = require("dap")
			
			-- Java adapter for standalone files
			dap.adapters.java = function(callback)
				-- Get current file info
				local current_file = vim.fn.expand("%:p")
				local current_dir = vim.fn.expand("%:p:h")
				local class_name = vim.fn.expand("%:t:r")
				
				-- Compile the Java file first
				local compile_cmd = string.format("javac -g '%s'", current_file)
				vim.fn.system(compile_cmd)
				
				-- Start Java with debug options
				local java_cmd = {
					"java",
					"-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=0",
					"-cp",
					current_dir,
					class_name
				}
				
				callback({
					type = "server",
					host = "127.0.0.1",
					port = "${port}",
					executable = {
						command = java_cmd[1],
						args = vim.list_slice(java_cmd, 2),
					},
				})
			end
			
			-- Simplified Java configuration for standalone files
			dap.configurations.java = {
				{
					type = "java",
					request = "launch",
					name = "Debug Current Java File",
					mainClass = function()
						return vim.fn.expand("%:t:r")
					end,
					classPaths = function()
						return { vim.fn.expand("%:p:h") }
					end,
				},
			}
			
			-- Function to automatically debug current Java file
			local function debug_java_file()
				local filetype = vim.bo.filetype
				if filetype ~= "java" then
					vim.notify("Not a Java file!", vim.log.levels.WARN)
					return
				end
				
				local current_file = vim.fn.expand("%:p")
				local current_dir = vim.fn.expand("%:p:h")
				local class_name = vim.fn.expand("%:t:r")
				
				-- Save the file first
				vim.cmd("write")
				
				-- Compile the Java file
				local compile_cmd = string.format("javac -g '%s'", current_file)
				local result = vim.fn.system(compile_cmd)
				
				if vim.v.shell_error ~= 0 then
					vim.notify("Compilation failed: " .. result, vim.log.levels.ERROR)
					return
				end
				
				-- Start debugging automatically
				dap.run({
					type = "java",
					request = "launch",
					name = "Debug Current Java File",
					mainClass = class_name,
					classPaths = { current_dir },
				})
			end
			
			-- DAP keybindings
			vim.keymap.set("n", "<F5>", function()
				if vim.bo.filetype == "java" then
					debug_java_file()
				else
					dap.continue()
				end
			end, { desc = "Debug: Auto Start Java / Continue" })
			
			vim.keymap.set("n", "<F1>", dap.step_into, { desc = "Debug: Step Into" })
			vim.keymap.set("n", "<F2>", dap.step_over, { desc = "Debug: Step Over" })
			vim.keymap.set("n", "<F3>", dap.step_out, { desc = "Debug: Step Out" })
			vim.keymap.set("n", "<leader>b", dap.toggle_breakpoint, { desc = "Debug: Toggle Breakpoint" })
			vim.keymap.set("n", "<leader>B", function()
				dap.set_breakpoint(vim.fn.input("Breakpoint condition: "))
			end, { desc = "Debug: Set Conditional Breakpoint" })
			vim.keymap.set("n", "<leader>dr", dap.repl.open, { desc = "Debug: Open REPL" })
			vim.keymap.set("n", "<leader>dl", dap.run_last, { desc = "Debug: Run Last" })
			
			-- Java-specific debug keymap
			vim.keymap.set("n", "<leader>dj", debug_java_file, { desc = "Debug: Run Current Java File" })
		end,
	},

	-- DAP Virtual Text
	{
		"theHamsta/nvim-dap-virtual-text",
		dependencies = { "mfussenegger/nvim-dap" },
		config = function()
			require("nvim-dap-virtual-text").setup({
				enabled = true,
				enabled_commands = true,
				highlight_changed_variables = true,
				highlight_new_as_changed = false,
				show_stop_reason = true,
				commented = false,
				only_first_definition = true,
				all_references = false,
				filter_references_pattern = '<module',
				virt_text_pos = 'eol',
				all_frames = false,
				virt_lines = false,
				virt_text_win_col = nil
			})
		end,
	},
}
